<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-26 iSpotter - Spotter Dashboard</title>
    <link rel="stylesheet" href="/Styling/spotter_styles.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="header-stream-controls">
                <button class="action-button start-btn" id="start-stream-btn">Start Stream</button>
                <button class="action-button stop-btn" id="stop-stream-btn">Stop Stream</button>
            </div>
            <span>POS: <span id="position">--</span></span>
            <span style="margin: 0 40px;">LAP: <span id="lap">--</span></span>
            <span>TIME: <span id="current-lap-time">99:99.999</span></span>
            <span style="margin: 0 40px;">STINT LAP: <span id="stint-lap">--</span></span>
            <a href="/" class="main-menu-btn">Main Menu</a>
        </div>

        <!-- Left Panel -->
        <div class="left-panel">

            <!-- Best Lap-->
            <div class="pit-wizard">
                <h3>Best Lap</h3>
                <table class="timing-table" id="best-ses-lap">
                    <thead>
                        <tr>
                            <th>Lap</th>
                            <th>Time</th>
                            <th>Live Delta</th>
                        </tr>
                    </thead>
                    <tbody id="bestlap-body">
                        <tr>
                            <td id="best-lap">--</td>
                            <td id="best-time">--:--</td>
                            <td id="delta-to-best">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!--Lap Time Wizard-->
            <div class="pit-wizard">
                <h3>Lap Time Wizard</h3>
                <div class="pit-info">
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Average Pace:</span>
                        <span id="avg-pace" style="font-size: 15px;">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Predicted Next Lap:</span>
                        <span id="predicted-lap" style="font-size: 15px;">--:--</span>
                    </div>
                </div>
            </div>

            <!--Pit Stop Wizard-->
            <div class="pit-wizard">
                <h3>Pit Stop Wizard</h3>
                <div class="pit-info">
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. pit stop time loss: </span>
                        <span style="font-size: 15px;" id="pit-time-loss">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. position at pit exit: </span>
                        <span style="font-size: 15px;" id="pit-exit-pos">--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. delta to behind at pit exit: </span>
                        <span style="font-size: 15px;" id="pit-exit-pos-delta">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Current Pit Stop Time: </span>
                        <span style="font-size: 15px;" id="curr-pit-stop">--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            
            <!-- Steering Balance Module -->
            <div class="steering-balance-module">
                <div class="steering-meter-wrapper">
                    <div class="steering-meter-background">
                        <div class="steering-center-line"></div>
                        <div class="steering-meter-bar" id="steeringBar"></div>
                    </div>
                </div>
            </div>

            <!-- Car Info -->
            <div class="sectors-module">
                <table class="sectors-table">
                    <thead>
                        <tr>
                            <th>Gear</th>
                            <th>RPM</th>
                            <th>Speed</th>
                            <!--<th>Fuel</th>-->
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="gear">-</td>
                            <td><span id="rpm">----</span> RPM</td>
                            <td id="speed">--- MPH</td>
                            <!--<td id="fuel">-- L</td>-->
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mini Sectors Table -->
            <div class="sectors-module">
                <h3>Mini-Sector Times</h3>
                <table class="sectors-table">
                    <thead>
                        <tr>
                            <th>MS1</th>
                            <th>MS2</th>
                            <th>MS3</th>
                            <th>MS4</th>
                            <th>MS5</th>
                            <th>MS6</th>
                            <th>MS7</th>
                            <th>MS8</th>
                            <th>MS9</th>
                            <th>MS10</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="sector-1">--:--</td>
                            <td id="sector-2">--:--</td>
                            <td id="sector-3">--:--</td>
                            <td id="sector-4">--:--</td>
                            <td id="sector-5">--:--</td>
                            <td id="sector-6">--:--</td>
                            <td id="sector-7">--:--</td>
                            <td id="sector-8">--:--</td>
                            <td id="sector-9">--:--</td>
                            <td id="sector-10">--:--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Lap Time Comparison Chart -->
            <div class="sectors-module">
                <h3>Lap Time Comparison</h3>
                <div class="chart-wrapper">
                    <canvas id="lapTimeChart"></canvas>
                </div>
            </div>

        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="section">
                <h3>Class Relative Timing</h3>
                <table class="timing-table" id="relative-timing">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Gap</th>
                            <th>Last Lap Delta</th>
                        </tr>
                    </thead>
                    <tbody id="timing-body">
                        <tr>
                            <td id="timing-1-pos">1</td>
                            <td id="timing-1-gap">--</td>
                            <td id="timing-1-delta">--</td>
                        </tr>
                        <tr>
                            <td id="timing-2-pos">--</td>
                            <td id="timing-2-gap">--</td>
                            <td id="timing-2-delta">--</td>
                        </tr>
                        <tr>
                            <td id="timing-3-pos">--</td>
                            <td id="timing-3-gap">--</td>
                            <td id="timing-3-delta">--</td>
                        </tr>
                        <tr>
                            <td id="timing-4-pos">--</td>
                            <td id="timing-4-gap">--</td>
                            <td id="timing-4-delta">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!--Start and stop telem stream-->
            <div class="section">
                <h3>Status</h3>
                <div id="stream-status" class="stream-status">
                    <div>Stream: <span id="status-text">Inactive</span></div>
                    <div>iRacing: <span id="iracing-status">Disabled</span></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Connect to Socket.IO server
        const socket = io('http://localhost:5000');

        // Initialize Chart.js chart
        const lapTimeCtx = document.getElementById('lapTimeChart').getContext('2d');

        // Lap time data storage
        let lapTimeUpdates = [];
        let currentLapTimes = [];
        let sessionBestTimes = [];

        // Lap Time Comparison Chart
        const lapTimeChart = new Chart(lapTimeCtx, {
            type: 'line',
            data: {
                labels: lapTimeUpdates,
                datasets: [
                    {
                        label: 'Your Best',
                        data: currentLapTimes,
                        borderColor: '#ffffff',
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        tension: 0.4,
                        pointHoverRadius: 7,
                        borderWidth: 2
                    },
                    {
                        label: 'Session Best',
                        data: sessionBestTimes,
                        borderColor: '#ff0000',
                        backgroundColor: 'rgba(255, 0, 0, 0.1)',
                        tension: 0.4,
                        pointHoverRadius: 7,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#ffffff',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 10
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#ffffff',
                            font: {
                                size: 11
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#ffffff',
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return formatTime(value);
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });

        // Format time as MM:SS.SSS
        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(3);
            return `${mins}:${secs.padStart(6, '0')}`;
        }

        // Function to update lap time chart
        function updateLapTimeChart(yourBestTime, sessionBestTime, lapNum) {
            lapTimeUpdates.push(lapNum);
            currentLapTimes.push(yourBestTime);
            sessionBestTimes.push(sessionBestTime);

            lapTimeChart.update();
        }

        // Handle incoming telemetry data
        socket.on('frame_update', (data) => {
            console.log('Received frame:', data);

            // Update iRacing connection status if available
            if (data.connection !== undefined) {
                updateIRacingStatus(data.connection);
            }

            // Update header info
            if (data.relative_timing && data.relative_timing.car_idx_position) {
                const position = data.relative_timing.car_idx_position || '--';
                const suffix = position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th';
                document.getElementById('position').textContent = position + suffix;
            }

            // Update header and wizard(s) info
            if (data.lap_times) {
                document.getElementById('lap').textContent = data.lap_times.lap || '--';
                document.getElementById('current-lap-time').textContent = formatTime(data.lap_times.lap_current_lap_time);
                
                const blap = data.lap_times.lap_best_lap_time;
                const p_delta = data.lap_times.live_delta || 0.0;
                const l_delta = data.lap_times.leader_delta || 0.0;

                if (blap && p_delta) {
                    document.getElementById('predicted-lap').textContent = formatTime(blap + p_delta);
                }

                const blb = document.getElementById('bestlap-body');
                if (blb) { 
                    document.getElementById('best-lap').textContent = data.lap_times.lap_best_lap ?? 0;
                    document.getElementById('best-time').textContent = formatTime(data.lap_times.lap_best_lap_time ?? 9999.99);
                    document.getElementById('delta-to-best').textContent = data.lap_times.live_delta ?? 0;
                }

                // Update mini sectors
                const sector = data.lap_times.current_sector || 1;
                document.getElementById(`sector-${sector}`).textContent = formatTime(data.lap_times.sector_time);
                document.getElementById(`sector-${sector}`).style.fontSize = '16px';

                if (sector == 1) {
                    for (let i = 2; i <= 10; i++) {
                        document.getElementById(`sector-${i}`).style.fontSize = '10px';
                        document.getElementById(`sector-${i}`).textContent = '--:--';
                        document.getElementById(`sector-${i}`).style.backgroundColor = '#2a2a2a';
                    }
                }
                if (sector > 1) {
                    document.getElementById(`sector-${sector - 1}`).style.fontSize = '10px';
                }

                if (p_delta && l_delta) {
                    if (p_delta <= 0 && l_delta <= 0) {
                        document.getElementById(`sector-${sector}`).style.backgroundColor = '#d900ffff';
                    } else if (p_delta <= 0) {
                        document.getElementById(`sector-${sector}`).style.backgroundColor = '#00ff00';
                    } else {
                        document.getElementById(`sector-${sector}`).style.backgroundColor = '#ff0000';
                    }
                }
            }

            if (data.lap_chart) {
                best_time = data.lap_chart.best_time || 0.0;
                session_time = data.lap_chart.session_time || 0.0;
                lap_num = data.lap_chart.lap || '';
                updateLapTimeChart(best_time, session_time, lap_num);
            }

            // Update header stint lap info
            if (data.stint_lap) {
                document.getElementById('stint-lap').textContent = data.stint_lap;
            }

            // Update car info in center panel
            if (data.drivetrain) {
                document.getElementById('gear').textContent = data.drivetrain.gear || '-';
                document.getElementById('rpm').textContent = Math.round(data.drivetrain.rpm) || '----';
            }

            if (data.basic_forces) {
                const speed = Math.round(data.basic_forces.velo * 0.621371); // Convert km/h to mph
                document.getElementById('speed').textContent = `${speed} MPH`;
            }

            if (data.consumables) {
                document.getElementById('fuel').textContent = `${data.consumables.fuel_level} L` || '-- L';
            }

            // Update pitstop wizard
            if (data.predictives) {
                document.getElementById("avg-pace").textContent = formatTime(data.predictives.Average_Pace) || '--:--';
                document.getElementById("pit-time-loss").textContent = formatTime(data.predictives.Predicted_Stop) || '--:--';
                document.getElementById("pit-exit-pos").textContent = data.predictives.Position_At_Pit_Exit || '--';
                document.getElementById("pit-exit-pos-delta").textContent = formatTime(data.predictives.Delta_To_Next) || '--:--';
            }

            // Update relative timing
            if (data.relative_timing) {
                const me_pos = data.relative_timing.car_idx_position;
                const gaps = data.relative_timing.gaps || [];
                const deltas = data.relative_timing.deltas || [];
                const classLength = deltas.length;
    
                let displayPositions;
    
                if (me_pos === 1) {
                    displayPositions = [1, 2, 3, 4];
                } else if (me_pos === 2) {
                    displayPositions = [1, 2, 3, 4];
                } else if (me_pos === classLength) {
                    displayPositions = [1, me_pos - 2, me_pos - 1, me_pos];
                } else {
                    displayPositions = [1, me_pos - 1, me_pos, me_pos + 1];
                }
    
                for (let i = 0; i < 4; i++) {
                    const rowNum = i + 1;
                    const position = displayPositions[i];
                    const gapIndex = position - 1;
        
                    const posCell = document.getElementById(`timing-${rowNum}-pos`);
                    const gapCell = document.getElementById(`timing-${rowNum}-gap`);
                    const deltaCell = document.getElementById(`timing-${rowNum}-delta`);
        
                    if (posCell && gapCell && deltaCell) {
                        posCell.textContent = position === me_pos ? 'You' : position;
                        gapCell.textContent = gaps[gapIndex] ?? '--';
                        deltaCell.textContent = deltas[gapIndex] ?? '--';
                    }
                }
            }
        });

        // Stream control functions
        let streamActive = false;

        // Start stream button handler
        document.getElementById('start-stream-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Start stream response:', data);
                
                if (data.status === 'success' || data.status === 'already_running') {
                    updateStreamStatus(true);
                }
            } catch (error) {
                console.error('Error starting stream:', error);
                alert('Failed to start stream: ' + error.message);
            }
        });

        // Stop stream button handler
        document.getElementById('stop-stream-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/stream/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Stop stream response:', data);
                
                if (data.status === 'success' || data.status === 'not_running') {
                    updateStreamStatus(false);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                alert('Failed to stop stream: ' + error.message);
            }
        });

        // Update UI based on stream status
        function updateStreamStatus(isActive) {
            streamActive = isActive;
            const statusText = document.getElementById('status-text');
            const startBtn = document.getElementById('start-stream-btn');
            const stopBtn = document.getElementById('stop-stream-btn');
            
            if (isActive) {
                statusText.textContent = 'Active';
                statusText.style.color = '#00ff00';
                startBtn.disabled = true;
                startBtn.style.opacity = '0.5';
                stopBtn.disabled = false;
                stopBtn.style.opacity = '1';
            } else {
                statusText.textContent = 'Inactive';
                statusText.style.color = '#ff0000';
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                stopBtn.disabled = true;
                stopBtn.style.opacity = '0.5';
            }
        }

        // Update iRacing connection status
        function updateIRacingStatus(isConnected) {
            const iracingStatus = document.getElementById('iracing-status');
            if (isConnected) {
                iracingStatus.textContent = 'Connected';
                iracingStatus.style.color = '#00ff00';
            } else {
                iracingStatus.textContent = 'Disconnected';
                iracingStatus.style.color = '#ff0000';
            }
        }

        // Listen for stream status updates from server
        socket.on('stream_status', (data) => {
            console.log('Stream status update:', data);
            updateStreamStatus(data.status === 'started');
        });

        // Check initial stream status
        async function checkStreamStatus() {
            try {
                const response = await fetch('/api/stream/status');
                const data = await response.json();
                updateStreamStatus(data.is_running);
                if (data.iracing_connected !== undefined) {
                    updateIRacingStatus(data.iracing_connected);
                }
            } catch (error) {
                console.error('Error checking stream status:', error);
            }
        }

        // Check status on page load
        checkStreamStatus();

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to telemetry server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from telemetry server');
        });
    </script>
</body>
</html>