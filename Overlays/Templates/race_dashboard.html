<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-26 iSpotter - Race Dashboard</title>
    <link rel="stylesheet" href="/Styling/race_styles.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <span>POS: <span id="position">--</span></span>
            <span style="margin: 0 40px;">LAP: <span id="lap">--</span></span>
            <span>TIME: <span id="current-lap-time">99:99.999</span></span>
            <span style="margin: 0 40px;">STINT LAP: <span id="stint-lap">--</span></span>
        </div>

        <!-- Header controls -->
        <div class="header">

            <!--Stream Status-->
            <div id="stream-status" class="stream-status">
                <div>Stream: <span id="status-text">Inactive</span></div>
                <div>iRacing: <span id="iracing-status">Disabled</span></div>
            </div>
            
            <button class="action-button start-btn" id="start-stream-btn">Start Stream</button>
            <button class="action-button stop-btn" id="stop-stream-btn">Stop Stream</button>
            <!-- <a href="/" class="main-menu-btn">Main Menu</a>-->
        </div>

        <!-- Left Panel -->
        <div class="left-panel">

            <!--Lap Time Wizard-->
            <div class="pit-wizard">
                <h3>Lap Time Wizard</h3>
                <div class="pit-info">
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Average Pace:</span>
                        <span id="avg-pace" style="font-size: 15px;">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Predicted Next Lap:</span>
                        <span id="predicted-lap" style="font-size: 15px;">--:--</span>
                    </div>
                </div>
            </div>

            <!--Pit Stop Wizard-->
            <div class="pit-wizard">
                <h3>Pit Stop Wizard</h3>
                <div class="pit-info">
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. pit stops remaining:</span>
                        <span  style="font-size: 15px;" id="predicted-stops">--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Laps left till next stop:</span>
                        <span style="font-size: 15px;" id="laps-fuel">--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Avg. fuel usage per lap: </span>
                        <span style="font-size: 15px;" id="avg-fuel-use">-- <span style="font-size: 15px;">L/Lap</span></span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Time left till next stop:</span> 
                        <span style="font-size: 15px;" id="time-fuel">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Avg. fuel use per hour </span>
                        <span style="font-size: 15px;" id="avg-fuel-hour">-- <span style="font-size: 15px;">L/Hour</span></span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. pit stop time loss: </span>
                        <span style="font-size: 15px;" id="pit-time-loss">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. position at pit exit: </span>
                        <span style="font-size: 15px;" id="pit-exit-pos">--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Est. delta to behind at pit exit: </span>
                        <span style="font-size: 15px;" id="pit-exit-pos-delta">--:--</span>
                    </div>
                    <div class="pit-info-row">
                        <span style="font-size: 15px;">Current Pit Stop Time: </span>
                        <span style="font-size: 15px;" id="curr-pit-stop">--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <!-- Telemetry Display Module -->
            <div class="telemetry-module">
                <!-- Line Chart -->
                <div class="line-chart-container">
                    <canvas id="lineChart"></canvas>
                </div>

                <!-- Input Bars -->
                <div class="input-bars-container">
                    <div class="input-bar clutch-bar">
                        <div class="input-bar-fill" id="clutch-fill"></div>
                    </div>
                    <div class="input-bar brake-bar">
                        <div class="input-bar-fill" id="brake-fill"></div>
                    </div>
                    <div class="input-bar throttle-bar">
                        <div class="input-bar-fill" id="throttle-fill"></div>
                    </div>
                </div>
            </div>

            <!-- Steering Balance Module -->
            <div class="steering-balance-module">
                <div class="balance-meter-wrapper">
                    <div class="balance-meter-background">
                        <div class="balance-center-line"></div>
                        <div class="balance-meter-bar" id="balanceBar"></div>
                    </div>
                </div>
                <div class="steering-meter-wrapper">
                    <div class="steering-meter-background">
                        <div class="steering-center-line"></div>
                        <div class="steering-meter-bar" id="steeringBar"></div>
                    </div>
                </div>
                <div class="balance-state-display">
                    <span class="balance-confidence-indicator" id="balanceStateText">NEUTRAL</span>
                    <div class="balance-confidence-indicator">PREDICTION CONFIDENCE: <span class="balance-confidence-indicator" id="balanceConfidenceText">--</span></div>
                </div>
            </div>

            <div class="sectors-module">
                    <!-- Car Info-->
                    <table class="sectors-table">
                        <thead>
                            <tr>
                                <th>Gear</th>
                                <th>RPM</th>
                                <th>Speed</th>
                                <th>Fuel</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="gear">-</td>
                                <td><span id="rpm">----</span> RPM</td>
                                <td id="speed">--- MPH</td>
                                <td id="fuel">-- L</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            <!-- Mini Sectors Table -->
            <div class="sectors-module">
                <h3>Mini-Sector Times</h3>
                <table class="sectors-table">
                    <thead>
                        <tr>
                            <th>MS1</th>
                            <th>MS2</th>
                            <th>MS3</th>
                            <th>MS4</th>
                            <th>MS5</th>
                            <th>MS6</th>
                            <th>MS7</th>
                            <th>MS8</th>
                            <th>MS9</th>
                            <th>MS10</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="sector-1">--:--</td>
                            <td id="sector-2">--:--</td>
                            <td id="sector-3">--:--</td>
                            <td id="sector-4">--:--</td>
                            <td id="sector-5">--:--</td>
                            <td id="sector-6">--:--</td>
                            <td id="sector-7">--:--</td>
                            <td id="sector-8">--:--</td>
                            <td id="sector-9">--:--</td>
                            <td id="sector-10">--:--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">

            <!-- Best Lap-->
            <div class="pit-wizard">
                <h3>Best Lap</h3>
                <table class="timing-table" id="best-ses-lap">
                    <thead>
                        <tr>
                            <th>Lap</th>
                            <th>Time</th>
                            <th>Live Delta</th>
                        </tr>
                    </thead>
                    <tbody id="bestlap-body">
                        <tr>
                            <td id="best-lap">--</td>
                            <td id="best-time">--:--</td>
                            <td id="delta-to-best">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!--Relative Timing-->
            <div class="section">
                <h3>Class Relative Timing</h3>
                <table class="timing-table" id="relative-timing">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Gap</th>
                            <th>Last Lap Delta</th>
                        </tr>
                    </thead>
                    <tbody id="timing-body">
                        <tr>
                            <td id="timing-1-pos">1</td>
                            <td id="timing-1-gap">--</td>
                            <td id="timing-1-delta">--</td>
                        </tr>
                        <tr>
                            <td id="timing-2-pos">--</td>
                            <td id="timing-2-gap">--</td>
                            <td id="timing-2-delta">--</td>
                        </tr>
                        <tr>
                            <td id="timing-3-pos">--</td>
                            <td id="timing-3-gap">--</td>
                            <td id="timing-3-delta">--</td>
                        </tr>
                        <tr>
                            <td id="timing-4-pos">--</td>
                            <td id="timing-4-gap">--</td>
                            <td id="timing-4-delta">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

    </div>
    <script>
        // Connect to Socket.IO server
        const socket = io('http://localhost:5000');

        // Line Chart Setup
        const canvas = document.getElementById('lineChart');
        const ctx = canvas.getContext('2d');

        // Set canvas size
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Data storage for line chart (input history)
        const maxDataPoints = 100;
        const throttleHistory = [];
        const brakeHistory = [];
        const clutchHistory = [];

        function drawLineChart() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
    
            if (throttleHistory.length < 2) return;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 5;

            // Draw throttle line (green)
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
    
            for (let i = 0; i < throttleHistory.length; i++) {
                const x = padding + (i / maxDataPoints) * (width - padding * 2);
                const y = height - padding - (throttleHistory[i]) * (height - padding * 2);
        
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // Draw brake line (red)
            ctx.strokeStyle = '#ff3333';
            ctx.lineWidth = 2;
            ctx.beginPath();
    
            for (let i = 0; i < brakeHistory.length; i++) {
                const x = padding + (i / maxDataPoints) * (width - padding * 2);
                const y = height - padding - (brakeHistory[i]) * (height - padding * 2);
        
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // Draw clutch line (blue)
            ctx.strokeStyle = '#0099ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
    
            for (let i = 0; i < clutchHistory.length; i++) {
                const x = padding + (i / maxDataPoints) * (width - padding * 2);
                const y = height - padding - (clutchHistory[i]) * (height - padding * 2);
        
            if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
        }

        // Update line chart with throttle, brake, clutch data
        function updateLineChart(throttle, brake, clutch) {
            throttleHistory.push(throttle);
            brakeHistory.push(brake);
            clutchHistory.push(clutch);
    
            if (throttleHistory.length > maxDataPoints) {
                throttleHistory.shift();
                brakeHistory.shift();
                clutchHistory.shift();
            }
    
            drawLineChart();
        }

        // Update input bars
        function updateInputBars(throttle, brake, clutch) {
            document.getElementById('throttle-fill').style.height = (throttle * 100) + '%';
            document.getElementById('brake-fill').style.height = (brake * 100) + '%';
            document.getElementById('clutch-fill').style.height = (clutch * 100) + '%';
        }

        function getStateColor(state) {
            switch(state) {
                case 'UNDERSTEER': return '#d70000';
                case 'OVERSTEER': return '#029000';
                case 'NEUTRAL': return '#4caf50';
                case 'TRANSIENT': return '#ff9800';
                default: return '#808080';
            }
        }

        function updateSteeringBalance(data) {
            const steeringBar = document.getElementById('steeringBar');
            const balanceBar = document.getElementById('balanceBar');
            const stateText = document.getElementById('balanceStateText');
            const confidenceText = document.getElementById('balanceConfidenceText');

            // Convert steering angle from radians to degrees, then to percentage
            const steeringAngleDeg = data.car_idx_steer * (180 / Math.PI);
            const steeringPercent = (steeringAngleDeg / 360) * 100;
            const steeringClampedPercent = Math.max(-50, Math.min(50, steeringPercent));

            // Position the steering bar
            steeringBar.style.left = `${50 + steeringClampedPercent}%`;

            if (data.is_valid) {
                const balancePercent = data.balance_clamped / 2; // Scale ±100 to ±50%
                balanceBar.style.left = `${50 + balancePercent}%`;
                balanceBar.style.backgroundColor = data.color;  // Apply gradient color
                balanceBar.style.opacity = data.confidence;     // Fade based on confidence of estimation
                confidenceText.textContent = data.confidence;
            } else {
                // Invalid data - center and gray out
                balanceBar.style.left = '50%';
                balanceBar.style.backgroundColor = '#808080';
                balanceBar.style.opacity = '0.3';
            }

            stateText.textContent = data.state;
            stateText.style.color = getStateColor(data.state);
        }

        // Format time as MM:SS.SSS
        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = (seconds % 60).toFixed(3);
            return `${mins}:${secs.padStart(6, '0')}`;
        }

        // Handle incoming telemetry data
        socket.on('frame_update', (data) => {
            console.log('Received frame:', data);

            // Update iRacing connection status if available
            if (data.connection !== undefined) {
                updateIRacingStatus(data.connection);
            }

            // Update header info
            if (data.relative_timing && data.relative_timing.car_idx_position) {
                const position = data.relative_timing.car_idx_position || '--';
                const suffix = position === 1 ? 'st' : position === 2 ? 'nd' : position === 3 ? 'rd' : 'th';
                document.getElementById('position').textContent = position + suffix;
            }
            //Update header and wizard(s) info
            if (data.lap_times) {
                document.getElementById('lap').textContent = data.lap_times.lap || '--';
                document.getElementById('current-lap-time').textContent = formatTime(data.lap_times.lap_current_lap_time);
                const blap = data.lap_times.lap_best_lap_time;
                const p_delta = data.lap_times.live_delta || 0.0;
                const l_delta = data.lap_times.leader_delta || 0.0;

                if (blap && p_delta){
                    document.getElementById('predicted-lap').textContent = formatTime(blap + p_delta);
                }
                const blb = document.getElementById('bestlap-body');
                if (blb) { 
                    document.getElementById('best-lap').textContent = data.lap_times.lap_best_lap ?? 0;
                    document.getElementById('best-time').textContent = formatTime(data.lap_times.lap_best_lap_time ?? 9999.99);
                    document.getElementById('delta-to-best').textContent = data.lap_times.live_delta ?? 0;
                }

                const sector = data.lap_times.current_sector || 1;
                document.getElementById(`sector-${sector}`).textContent = formatTime(data.lap_times.sector_time);
                document.getElementById(`sector-${sector}`).style.fontSize = '16px';

                if (sector == 1) {
                    for (let i = 2; i < 10; i++) {
                        document.getElementById(`sector-${i}`).style.fontSize = '10px';
                        document.getElementById(`sector-${i}`).textContent = '--:--';
                        document.getElementById(`sector-${i}`).style.backgroundColor = '#2a2a2a';
                    }
                }
                if (sector > 1) {
                    document.getElementById(`sector-${sector - 1}`).style.fontSize = '10px';
                }

                if (p_delta && l_delta) {
                    if (p_delta <= 0 && l_delta <= 0) {
                        document.getElementById(`sector-${sector}`).style.backgroundColor = '#d900ffff';
                    } else if (p_delta <= 0) {
                        document.getElementById(`sector-${sector}`).style.backgroundColor = '#00ff00';
                    } else {
                        document.getElementById(`sector-${sector}`).style.backgroundColor = '#ff0000';
                    }

                    }
                }
            //Update header stint lap info
            if (data.stint_lap){
                document.getElementById('stint-lap').textContent = data.stint_lap;
            }

            // Update car info in center panel
            if (data.drivetrain) {
                document.getElementById('gear').textContent = data.drivetrain.gear || '-';
                document.getElementById('rpm').textContent = Math.round(data.drivetrain.rpm) || '----';
            }
            //Update car info and trace
            if (data.basic_forces) {
                const speed = Math.round(data.basic_forces.velo * 0.621371); // Convert km/h to mph
                document.getElementById('speed').textContent = `${speed} MPH`;
                const throttle = data.basic_forces.throttle || 0;
                const brake = data.basic_forces.brake || 0;
                const clutch = data.basic_forces.clutch || 0;
    
                // Update the vertical bars
                updateInputBars(throttle, brake, clutch);
    
                // Update the line chart (showing input history)
                updateLineChart(throttle, brake, clutch);
            }
            //Update car info fuel
            if (data.consumables){
                document.getElementById("fuel").textContent = `${data.consumables.fuel_level} L` || '-- L';
            }
            //Update pitstop wizard
            if (data.predictives) {
                document.getElementById("laps-fuel").textContent = data.predictives.Fuel_Laps_Remaining || '--';
                document.getElementById("time-fuel").textContent = formatTime(data.predictives.Fuel_Time_Remaining) || '--';
                document.getElementById("predicted-stops").textContent = data.predictives.Predicted_Stops_Remaining || '--';
                document.getElementById("avg-pace").textContent = formatTime(data.predictives.Average_Pace) || '--:--';
                document.getElementById("pit-time-loss").textContent = formatTime(data.predictives.Predicted_Stop) || '--:--';
                document.getElementById("pit-exit-pos").textContent = data.predictives.Position_At_Pit_Exit || '--';
                document.getElementById("pit-exit-pos-delta").textContent = formatTime(data.predictives.Delta_To_Next) || '--:--';
                document.getElementById("avg-fuel-use").textContent = data.predictives.Average_Fuel_Usage || '--';
                document.getElementById("avg-fuel-hour").textContent = data.predictives.Average_Fuel_Hour || '--';
                document.getElementyById("curr-pit-stop").textContent = formatTime(data.predictives.Current_Pit_Time) || '--:--';
            }
            //Update relative timing
            if (data.relative_timing) {
                const me_pos = data.relative_timing.car_idx_position;
                const gaps = data.relative_timing.gaps || [];
                const deltas = data.relative_timing.deltas || [];
                const classLength = deltas.length;
    
                // Define which positions to show in each row based on player position
                let displayPositions;
    
                if (me_pos === 1) {
                    // Leader: show positions you, 2, 3, 4
                    displayPositions = [1, 2, 3, 4];
                } else if (me_pos === 2) {
                    // 2nd place: show positions 1, you, 3, 4
                    displayPositions = [1, 2, 3, 4];
                } else if (me_pos === classLength) {
                    // Last place: show leader, P-2, P-1, you
                    displayPositions = [1, me_pos - 2, me_pos - 1, me_pos];
                } else {
                    // Middle of pack: show leader, P-1, you, P+1
                    displayPositions = [1, me_pos - 1, me_pos, me_pos + 1];
                }
    
                // Update each row dynamically
                for (let i = 0; i < 4; i++) {
                    const rowNum = i + 1;
                    const position = displayPositions[i];
                    const gapIndex = position - 1;
        
                    const posCell = document.getElementById(`timing-${rowNum}-pos`);
                    const gapCell = document.getElementById(`timing-${rowNum}-gap`);
                    const deltaCell = document.getElementById(`timing-${rowNum}-delta`);
        
                    if (posCell && gapCell && deltaCell) {
                        // Display position (or "You" if it's the player)
                        posCell.textContent = position === me_pos ? 'You' : position;
            
                        // Display gap and delta
                        gapCell.textContent = gaps[gapIndex] ?? '--';
                        deltaCell.textContent = deltas[gapIndex] ?? '--';
                    }
                }
            }

            if (data.dynamics){
                updateSteeringBalance(data.dynamics);
            }
        });

        // Stream control functions
        let streamActive = false;

        // Start stream button handler
        document.getElementById('start-stream-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Start stream response:', data);
                
                if (data.status === 'success' || data.status === 'already_running') {
                    updateStreamStatus(true);
                }
            } catch (error) {
                console.error('Error starting stream:', error);
                alert('Failed to start stream: ' + error.message);
            }
        });

        // Stop stream button handler
        document.getElementById('stop-stream-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/stream/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Stop stream response:', data);
                
                if (data.status === 'success' || data.status === 'not_running') {
                    updateStreamStatus(false);
                }
            } catch (error) {
                console.error('Error stopping stream:', error);
                alert('Failed to stop stream: ' + error.message);
            }
        });

        // Update UI based on stream status
        function updateStreamStatus(isActive) {
            streamActive = isActive;
            const statusText = document.getElementById('status-text');
            const startBtn = document.getElementById('start-stream-btn');
            const stopBtn = document.getElementById('stop-stream-btn');
            
            if (isActive) {
                statusText.textContent = 'Active';
                statusText.style.color = '#00ff00';
                startBtn.disabled = true;
                startBtn.style.opacity = '0.5';
                stopBtn.disabled = false;
                stopBtn.style.opacity = '1';
            } else {
                statusText.textContent = 'Inactive';
                statusText.style.color = '#ff0000';
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                stopBtn.disabled = true;
                stopBtn.style.opacity = '0.5';
            }
        }

        // Update iRacing connection status
        function updateIRacingStatus(isConnected) {
            const iracingStatus = document.getElementById('iracing-status');
            if (isConnected) {
                iracingStatus.textContent = 'Connected';
                iracingStatus.style.color = '#00ff00';
            } else {
                iracingStatus.textContent = 'Disconnected';
                iracingStatus.style.color = '#ff0000';
            }
        }

        // Listen for stream status updates from server
        socket.on('stream_status', (data) => {
            console.log('Stream status update:', data);
            updateStreamStatus(data.status === 'started');
        });

        // Check initial stream status
        async function checkStreamStatus() {
            try {
                const response = await fetch('/api/stream/status');
                const data = await response.json();
                updateStreamStatus(data.is_running);
                if (data.iracing_connected !== undefined) {
                    updateIRacingStatus(data.iracing_connected);
                }
            } catch (error) {
                console.error('Error checking stream status:', error);
            }
        }

        // Check status on page load
        checkStreamStatus();

        // Connection status
        socket.on('connect', () => {
            console.log('Connected to telemetry server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from telemetry server');
        });
    </script>
</body>
</html>